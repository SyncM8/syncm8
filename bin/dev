#!/bin/bash

# Create containers
runDockerUp(){
    user_id=$(id -u) group_id=$(id -g) docker-compose up --detach
}

# Create containers and attach backend to shell to faciliatate pdb
runDockerDebug(){
    runDockerUp
    container_id=$(docker ps|grep syncm8_api|cut -d' ' -f1)
    cmd="docker attach "$container_id
    echo $cmd
    exec $cmd
}

# Stop and remove all active containers associated with syncm8
runDockerDown(){
    user_id=$(id -u) group_id=$(id -g) docker-compose down
}

# Stop and remove all active containers associated with syncm8
runDockerPs(){
    docker-compose ps
}

# Stop and remove all active containers and delete all db data
runDockerClean(){
    runDockerDown
    docker volume prune -f
}

# Build images for all syncm8 containers
runDockerBuild(){
    user_id=$(id -u) group_id=$(id -g) docker-compose build
}

# Force rebuild all containers from scratch and update to newest versions
runDockerRebuild(){
    runDockerClean
    user_id=$(id -u) group_id=$(id -g) docker-compose build --pull --no-cache
}

# Run frontend webpack
runWebpack(){
    cd client
    npm run start
}

# Run pytest
runPytest(){
    container_id=$(docker ps|grep syncm8_api|cut -d' ' -f1)
    cmd="docker exec "$container_id" pytest "$*
    echo $cmd
    exec $cmd
}

# Run js tests
runJstest(){
    cd client
    npm run test
}

# Run precommit inside container
runPrecommit(){
    container_id=$(docker ps|grep syncm8_api|cut -d' ' -f1)
    cmd="docker exec -w /home/worker/app/ "$container_id" pre-commit "$*
    echo $cmd
    exec $cmd
}

runPrecommitCi(){
    container_id=$(docker ps|grep syncm8_api|cut -d' ' -f1)
    cmd=" docker exec -w /home/worker/app/ "$container_id" pre-commit hook-impl
        --config=.pre-commit-config.yaml --hook-type=pre-commit --hook-dir ."
    echo $cmd
    exec $cmd
}

runSetup(){
    cp bin/pre-commit .git/hooks/pre-commit
}

operation=$1
restArgs="${@:2}"

if [ $operation == 'debug' ] || [ $operation == 'backend' ]; then
runDockerDebug
elif [ $operation == 'up' ]; then
runDockerUp
elif [ $operation == 'down' ]; then
runDockerDown
elif [ $operation == 'ps' ]; then
runDockerPs
elif [ $operation == 'clean' ]; then
runDockerClean
elif [ $operation == 'build' ]; then
runDockerBuild
elif [ $operation == 'rebuild' ]; then
runDockerRebuild
elif [ $operation == 'webpack' ] || [ $operation == 'frontend' ]; then
runWebpack
elif [ $operation == 'pytest' ]; then
runPytest $restArgs
elif [ $operation == 'jstest' ]; then
runJstest
elif [ $operation == 'pre-commit' ]; then
runPrecommit
elif [ $operation == 'pre-commit-ci' ]; then
runPrecommitCi
elif [ $operation == 'setup' ]; then
runSetup
else
echo "Not IMPL"
fi
